{{ 'product-tabs.css' | asset_url | stylesheet_tag }}

{%- comment -%}
  Check for Vitals app integration
  If Vitals Product Description Tabs is enabled, this section will be hidden
{%- endcomment -%}
{%- unless shop.metafields.vitals.product_tabs_enabled -%}
<product-tabs class="product-tabs page-width" data-vitals-compatible="true">
  <nav class="product-tabs__nav">
    <button class="product-tabs__nav-link" type="button">
      {{ section.settings.description_tab_label | default: 'Description' }}
    </button>
    {%- if section.settings.show_reviews_tab -%}
      <button class="product-tabs__nav-link" type="button">
        {{ section.settings.reviews_tab_label | default: 'Reviews' }}
      </button>
    {%- endif -%}
    {%- for block in section.blocks -%}
      {%- case block.type -%}
        {%- when 'custom_tab' -%}
          <button class="product-tabs__nav-link" type="button" {{ block.shopify_attributes }}>
            {{ block.settings.tab_label | default: 'Custom Tab' }}
          </button>
      {%- endcase -%}
    {%- endfor -%}
  </nav>

  <div class="product-tabs__content">
    <div class="product-tabs__panel">
      {%- comment -%} Show product description at the top {%- endcomment -%}
      {%- if product.description != blank -%}
        {%- assign full_description = product.description -%}
        {%- assign description_only = '' -%}
        
        {%- comment -%} Split content at "Key Features:" or similar markers {%- endcomment -%}
        {%- if full_description contains 'Key Features:' -%}
          {%- assign description_parts = full_description | split: 'Key Features:' -%}
          {%- assign description_only = description_parts[0] | strip -%}
        {%- elsif full_description contains 'Features:' -%}
          {%- assign description_parts = full_description | split: 'Features:' -%}
          {%- assign description_only = description_parts[0] | strip -%}
        {%- elsif full_description contains '<ul>' or full_description contains '<li>' -%}
          {%- comment -%} If contains HTML lists, extract text before first list {%- endcomment -%}
          {%- assign description_parts = full_description | split: '<ul>' -%}
          {%- assign description_only = description_parts[0] | strip -%}
        {%- else -%}
          {%- assign description_only = full_description -%}
        {%- endif -%}
        
        <div class="product-tabs__description">
          <h4>Product Overview</h4>
          <div class="rte">
            {%- assign clean_description = description_only | replace: '---FEATURES---', '' | strip -%}
            {{ clean_description }}
          </div>
        </div>
      {%- endif -%}
      
      {%- comment -%} Features section with dropdown functionality {%- endcomment -%}
      {%- assign extracted_features = blank -%}
      {%- assign key_features = blank -%}
      
      {%- comment -%} Extract features from product description {%- endcomment -%}
      {%- if product.description != blank -%}
        {%- assign full_description = product.description -%}
        
        {%- comment -%} Extract content after "Key Features:" or "Features:" {%- endcomment -%}
        {%- if full_description contains 'Key Features:' -%}
          {%- assign description_parts = full_description | split: 'Key Features:' -%}
          {%- if description_parts.size > 1 -%}
            {%- assign extracted_features = description_parts[1] | strip -%}
          {%- endif -%}
        {%- elsif full_description contains 'Features:' -%}
          {%- assign description_parts = full_description | split: 'Features:' -%}
          {%- if description_parts.size > 1 -%}
            {%- assign extracted_features = description_parts[1] | strip -%}
          {%- endif -%}
        {%- elsif full_description contains '<ul>' -%}
          {%- comment -%} Extract HTML list content {%- endcomment -%}
          {%- assign ul_parts = full_description | split: '<ul>' -%}
          {%- if ul_parts.size > 1 -%}
            {%- assign list_content = ul_parts[1] | split: '</ul>' | first -%}
            {%- assign extracted_features = '<ul>' | append: list_content | append: '</ul>' -%}
          {%- endif -%}
        {%- endif -%}
      {%- endif -%}
      
      {%- comment -%} Prioritize extracted features, then metafields {%- endcomment -%}
      {%- if extracted_features != blank -%}
        {%- assign key_features = extracted_features -%}
      {%- elsif product.metafields.custom.key_features != blank -%}
        {%- assign key_features = product.metafields.custom.key_features -%}
      {%- endif -%}

      {%- if key_features != blank -%}
        <div class="product-tabs__features">
          <h4 style="margin-bottom: 1rem;">Key Features</h4>
          
          {%- comment -%} Parse features into dropdown list {%- endcomment -%}
          {%- assign features_list = blank -%}
          {%- if key_features contains '|' -%}
            {%- assign features_list = key_features | split: '|' -%}
          {%- elsif key_features contains '<li>' -%}
            {%- assign li_items = key_features | split: '<li>' -%}
            {%- assign features_list = '' | split: ',' -%}
            {%- for item in li_items -%}
              {%- unless forloop.first -%}
                {%- assign clean_item = item | split: '</li>' | first | strip_html | strip -%}
                {%- if clean_item != blank -%}
                  {%- assign features_list = features_list | append: clean_item | append: '|' | split: '|' -%}
                {%- endif -%}
              {%- endunless -%}
            {%- endfor -%}
          {%- else -%}
            {%- assign features_list = key_features | split: '
' -%}
          {%- endif -%}

          <ul class="product-tabs__features-list">
            {%- for feature in features_list -%}
              {%- assign feature_trimmed = feature | strip -%}
              {%- unless feature_trimmed == blank -%}
                <li class="product-tabs__features-item">
                  <div class="product-tabs__features-header" onclick="toggleFeature(this)" style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #eee;">
                    <span style="flex: 1;">{{ feature_trimmed }}</span>
                    <svg class="feature-toggle" viewBox="0 0 16 16" style="width: 16px; height: 16px; transition: transform 0.3s ease;">
                      <path d="M8 12l-4-4h8l-4 4z" fill="currentColor"/>
                    </svg>
                  </div>
                  <div class="product-tabs__features-details" style="display: none; padding: 0.5rem 0; color: #666;">
                    <p>{{ feature_trimmed | append: ' - Professional grade component designed for optimal performance and reliability.' }}</p>
                  </div>
                </li>
              {%- endunless -%}
            {%- endfor -%}
          </ul>
        </div>
      {%- else -%}
        <div class="product-tabs__features-placeholder">
          <p>{{ section.settings.no_description_text | default: 'No description available for this product.' }}</p>
        </div>
      {%- endif -%}
    </div>

    {%- if section.settings.show_reviews_tab -%}
      <div class="product-tabs__panel">
        {%- comment -%} Vitals App Block Integration in Reviews Tab {%- endcomment -%}
        {%- for block in section.blocks -%}
          {%- case block.type -%}
            {%- when '@app' -%}
              <div class="vitals-app-block" {{ block.shopify_attributes }}>
                {% render block %}
              </div>
            {%- when 'vitals_reviews' -%}
              <div class="vitals-reviews-block" {{ block.shopify_attributes }}>
                {% render block %}
              </div>
          {%- endcase -%}
        {%- endfor -%}
        
        {%- comment -%} Show message if no app blocks added {%- endcomment -%}
        {%- assign has_app_blocks = false -%}
        {%- for block in section.blocks -%}
          {%- if block.type == '@app' or block.type == 'vitals_reviews' -%}
            {%- assign has_app_blocks = true -%}
            {%- break -%}
          {%- endif -%}
        {%- endfor -%}
        
        {%- unless has_app_blocks -%}
          <div class="reviews-setup-message" style="padding: 2rem; text-align: center; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
            <h4 style="color: #333; margin-bottom: 1rem;">Add Vitals Reviews</h4>
            <p style="color: #666; margin-bottom: 1rem;">To show reviews here, add the Vitals Reviews app block:</p>
            <ol style="text-align: left; max-width: 400px; margin: 0 auto; color: #666;">
              <li>Click "Add block" below this section</li>
              <li>Select "Vitals Reviews" from the app blocks</li>
              <li>Configure the reviews settings</li>
            </ol>
          </div>
        {%- endunless -%}
      </div>
    {%- endif -%}

    {%- for block in section.blocks -%}
      {%- case block.type -%}
        {%- when 'custom_tab' -%}
          <div class="product-tabs__panel" {{ block.shopify_attributes }}>
            {%- if block.settings.tab_content != blank -%}
              <div class="rte">
                {{ block.settings.tab_content }}
              </div>
            {%- else -%}
              <div class="product-tabs__reviews-placeholder">
                <p>{{ block.settings.placeholder_text | default: 'Content coming soon...' }}</p>
              </div>
            {%- endif -%}
          </div>
      {%- endcase -%}
    {%- endfor -%}
  </div>
</product-tabs>

{%- comment -%}
  Vitals Product Description Tabs Integration Area
  When Vitals is enabled, tabs will appear here automatically
{%- endcomment -%}
<div id="vitals-product-tabs-container" data-product-id="{{ product.id }}"></div>
{%- endunless -%}

<script>
  function toggleFeature(element) {
    const details = element.nextElementSibling;
    const toggle = element.querySelector('.feature-toggle');
    
    if (details.style.display === 'none' || !details.style.display) {
      details.style.display = 'block';
      toggle.style.transform = 'rotate(180deg)';
    } else {
      details.style.display = 'none';
      toggle.style.transform = 'rotate(0deg)';
    }
  }
</script>
<script src="{{ 'product-tabs.js' | asset_url }}" defer="defer"></script>

{% schema %}
{
  "name": "Product Tabs",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Tab Labels"
    },
    {
      "type": "text",
      "id": "description_tab_label",
      "label": "Description Tab Label",
      "default": "Description"
    },
    {
      "type": "text",
      "id": "reviews_tab_label", 
      "label": "Reviews Tab Label",
      "default": "Reviews"
    },
    {
      "type": "header",
      "content": "Reviews Settings"
    },
    {
      "type": "checkbox",
      "id": "show_reviews_tab",
      "label": "Show Reviews Tab",
      "info": "Enable to show the Reviews tab with Vitals reviews widget",
      "default": true
    },
    {
      "type": "header",
      "content": "Description Settings"
    },
    {
      "type": "text",
      "id": "no_description_text",
      "label": "No Description Text",
      "default": "No description available for this product."
    },
    {
      "type": "header",
      "content": "Vitals Integration"
    },
    {
      "type": "checkbox",
      "id": "enable_vitals_integration",
      "label": "Enable Vitals Product Tabs Integration",
      "info": "When enabled, this section will be hidden if Vitals Product Description Tabs app is active",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "@app"
    },
    {
      "type": "custom_tab",
      "name": "Custom Tab",
      "settings": [
        {
          "type": "text",
          "id": "tab_label",
          "label": "Tab Label",
          "default": "Custom Tab"
        },
        {
          "type": "richtext",
          "id": "tab_content",
          "label": "Tab Content"
        },
        {
          "type": "text",
          "id": "placeholder_text",
          "label": "Placeholder Text",
          "default": "Content coming soon..."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product Tabs"
    }
  ]
}
{% endschema %}