{% comment %}
  Product Description Tabs with Vitals Integration
  
  This snippet creates tabbed interface for product features using metafields
  and integrates with Vitals app for enhanced product information display.
  
  Required metafields:
  - features.key_features
  - features.technical_specs  
  - features.applications
  - features.benefits
  - features.installation
  - features.warranty
  - features.video_url
  - features.brochure_url
{% endcomment %}

{% liquid
  assign has_features = false
  assign has_specs = false
  assign has_applications = false
  assign has_benefits = false
  assign has_installation = false
  assign has_warranty = false
  assign has_video = false
  assign has_brochure = false

  if product.metafields.features.key_features != blank
    assign has_features = true
  endif
  
  if product.metafields.features.technical_specs != blank
    assign has_specs = true
  endif
  
  if product.metafields.features.applications != blank
    assign has_applications = true
  endif
  
  if product.metafields.features.benefits != blank
    assign has_benefits = true
  endif
  
  if product.metafields.features.installation != blank
    assign has_installation = true
  endif
  
  if product.metafields.features.warranty != blank
    assign has_warranty = true
  endif
  
  if product.metafields.features.video_url != blank
    assign has_video = true
  endif
  
  if product.metafields.features.brochure_url != blank
    assign has_brochure = true
  endif

  assign has_any_tabs = false
  if has_features or has_specs or has_applications or has_benefits or has_installation or has_warranty or has_video or has_brochure
    assign has_any_tabs = true
  endif
%}

{% if has_any_tabs %}
<div class="product-tabs-container vitals-enhanced" data-vitals-product-tabs>
  <div class="product-tabs__navigation">
    <ul class="product-tabs__nav-list" role="tablist">
      {% if has_features %}
        <li class="product-tabs__nav-item">
          <button 
            class="product-tabs__nav-button active" 
            role="tab" 
            aria-selected="true"
            aria-controls="tab-features-{{ product.id }}"
            id="nav-features-{{ product.id }}"
            data-tab="features"
          >
            {% render 'icon-features' %}
            <span>Key Features</span>
          </button>
        </li>
      {% endif %}
      
      {% if has_specs %}
        <li class="product-tabs__nav-item">
          <button 
            class="product-tabs__nav-button{% unless has_features %} active{% endunless %}" 
            role="tab" 
            aria-selected="{% unless has_features %}true{% else %}false{% endunless %}"
            aria-controls="tab-specs-{{ product.id }}"
            id="nav-specs-{{ product.id }}"
            data-tab="specs"
          >
            {% render 'icon-specifications' %}
            <span>Specifications</span>
          </button>
        </li>
      {% endif %}
      
      {% if has_applications %}
        <li class="product-tabs__nav-item">
          <button 
            class="product-tabs__nav-button{% unless has_features or has_specs %} active{% endunless %}" 
            role="tab" 
            aria-selected="{% unless has_features or has_specs %}true{% else %}false{% endunless %}"
            aria-controls="tab-applications-{{ product.id }}"
            id="nav-applications-{{ product.id }}"
            data-tab="applications"
          >
            {% render 'icon-applications' %}
            <span>Applications</span>
          </button>
        </li>
      {% endif %}
      
      {% if has_benefits %}
        <li class="product-tabs__nav-item">
          <button 
            class="product-tabs__nav-button" 
            role="tab" 
            aria-selected="false"
            aria-controls="tab-benefits-{{ product.id }}"
            id="nav-benefits-{{ product.id }}"
            data-tab="benefits"
          >
            {% render 'icon-benefits' %}
            <span>Benefits</span>
          </button>
        </li>
      {% endif %}
      
      {% if has_installation %}
        <li class="product-tabs__nav-item">
          <button 
            class="product-tabs__nav-button" 
            role="tab" 
            aria-selected="false"
            aria-controls="tab-installation-{{ product.id }}"
            id="nav-installation-{{ product.id }}"
            data-tab="installation"
          >
            {% render 'icon-installation' %}
            <span>Installation</span>
          </button>
        </li>
      {% endif %}
      
      {% if has_warranty %}
        <li class="product-tabs__nav-item">
          <button 
            class="product-tabs__nav-button" 
            role="tab" 
            aria-selected="false"
            aria-controls="tab-warranty-{{ product.id }}"
            id="nav-warranty-{{ product.id }}"
            data-tab="warranty"
          >
            {% render 'icon-warranty' %}
            <span>Warranty</span>
          </button>
        </li>
      {% endif %}
      
      {% if has_video %}
        <li class="product-tabs__nav-item">
          <button 
            class="product-tabs__nav-button" 
            role="tab" 
            aria-selected="false"
            aria-controls="tab-video-{{ product.id }}"
            id="nav-video-{{ product.id }}"
            data-tab="video"
          >
            {% render 'icon-video' %}
            <span>Video</span>
          </button>
        </li>
      {% endif %}
      
      {% if has_brochure %}
        <li class="product-tabs__nav-item">
          <button 
            class="product-tabs__nav-button" 
            role="tab" 
            aria-selected="false"
            aria-controls="tab-brochure-{{ product.id }}"
            id="nav-brochure-{{ product.id }}"
            data-tab="brochure"
          >
            {% render 'icon-download' %}
            <span>Downloads</span>
          </button>
        </li>
      {% endif %}
    </ul>
  </div>

  <div class="product-tabs__content">
    {% if has_features %}
      <div 
        class="product-tabs__panel active" 
        role="tabpanel"
        aria-labelledby="nav-features-{{ product.id }}"
        id="tab-features-{{ product.id }}"
        data-tab-content="features"
      >
        <div class="product-tabs__panel-content">
          <h3 class="product-tabs__panel-title">Key Features</h3>
          <div class="product-tabs__features-list">
            {% assign features_list = product.metafields.features.key_features | split: '|' %}
            <ul class="features-grid">
              {% for feature in features_list %}
                {% unless feature == blank %}
                  <li class="feature-item">
                    {% render 'icon-check-circle' %}
                    <span>{{ feature | strip }}</span>
                  </li>
                {% endunless %}
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
    {% endif %}
    
    {% if has_specs %}
      <div 
        class="product-tabs__panel{% unless has_features %} active{% endunless %}" 
        role="tabpanel"
        aria-labelledby="nav-specs-{{ product.id }}"
        id="tab-specs-{{ product.id }}"
        data-tab-content="specs"
      >
        <div class="product-tabs__panel-content">
          <h3 class="product-tabs__panel-title">Technical Specifications</h3>
          <div class="product-tabs__specs-table">
            {% assign specs_list = product.metafields.features.technical_specs | split: '|' %}
            <table class="specs-table">
              <tbody>
                {% for spec in specs_list %}
                  {% unless spec == blank %}
                    {% assign spec_parts = spec | split: ':' %}
                    {% if spec_parts.size == 2 %}
                      <tr>
                        <td class="spec-label">{{ spec_parts[0] | strip }}</td>
                        <td class="spec-value">{{ spec_parts[1] | strip }}</td>
                      </tr>
                    {% endif %}
                  {% endunless %}
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    {% endif %}
    
    {% if has_applications %}
      <div 
        class="product-tabs__panel{% unless has_features or has_specs %} active{% endunless %}" 
        role="tabpanel"
        aria-labelledby="nav-applications-{{ product.id }}"
        id="tab-applications-{{ product.id }}"
        data-tab-content="applications"
      >
        <div class="product-tabs__panel-content">
          <h3 class="product-tabs__panel-title">Applications</h3>
          <div class="product-tabs__applications-list">
            {% assign applications_list = product.metafields.features.applications | split: '|' %}
            <ul class="applications-grid">
              {% for application in applications_list %}
                {% unless application == blank %}
                  <li class="application-item">
                    {% render 'icon-target' %}
                    <span>{{ application | strip }}</span>
                  </li>
                {% endunless %}
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
    {% endif %}
    
    {% if has_benefits %}
      <div 
        class="product-tabs__panel" 
        role="tabpanel"
        aria-labelledby="nav-benefits-{{ product.id }}"
        id="tab-benefits-{{ product.id }}"
        data-tab-content="benefits"
      >
        <div class="product-tabs__panel-content">
          <h3 class="product-tabs__panel-title">Benefits</h3>
          <div class="product-tabs__benefits-list">
            {% assign benefits_list = product.metafields.features.benefits | split: '|' %}
            <ul class="benefits-grid">
              {% for benefit in benefits_list %}
                {% unless benefit == blank %}
                  <li class="benefit-item">
                    {% render 'icon-star' %}
                    <span>{{ benefit | strip }}</span>
                  </li>
                {% endunless %}
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
    {% endif %}
    
    {% if has_installation %}
      <div 
        class="product-tabs__panel" 
        role="tabpanel"
        aria-labelledby="nav-installation-{{ product.id }}"
        id="tab-installation-{{ product.id }}"
        data-tab-content="installation"
      >
        <div class="product-tabs__panel-content">
          <h3 class="product-tabs__panel-title">Installation Information</h3>
          <div class="product-tabs__installation-content">
            <div class="installation-text">
              {{ product.metafields.features.installation }}
            </div>
          </div>
        </div>
      </div>
    {% endif %}
    
    {% if has_warranty %}
      <div 
        class="product-tabs__panel" 
        role="tabpanel"
        aria-labelledby="nav-warranty-{{ product.id }}"
        id="tab-warranty-{{ product.id }}"
        data-tab-content="warranty"
      >
        <div class="product-tabs__panel-content">
          <h3 class="product-tabs__panel-title">Warranty Information</h3>
          <div class="product-tabs__warranty-content">
            <div class="warranty-text">
              {{ product.metafields.features.warranty }}
            </div>
          </div>
        </div>
      </div>
    {% endif %}
    
    {% if has_video %}
      <div 
        class="product-tabs__panel" 
        role="tabpanel"
        aria-labelledby="nav-video-{{ product.id }}"
        id="tab-video-{{ product.id }}"
        data-tab-content="video"
      >
        <div class="product-tabs__panel-content">
          <h3 class="product-tabs__panel-title">Product Video</h3>
          <div class="product-tabs__video-content">
            <div class="video-wrapper">
              {% assign video_url = product.metafields.features.video_url %}
              {% if video_url contains 'youtube.com' or video_url contains 'youtu.be' %}
                {% assign video_id = video_url | split: 'v=' | last | split: '&' | first %}
                {% if video_url contains 'youtu.be' %}
                  {% assign video_id = video_url | split: '/' | last | split: '?' | first %}
                {% endif %}
                <iframe 
                  src="https://www.youtube.com/embed/{{ video_id }}" 
                  frameborder="0" 
                  allowfullscreen
                  loading="lazy"
                  title="Product demonstration video for {{ product.title }}"
                ></iframe>
              {% elsif video_url contains 'vimeo.com' %}
                {% assign video_id = video_url | split: '/' | last %}
                <iframe 
                  src="https://player.vimeo.com/video/{{ video_id }}" 
                  frameborder="0" 
                  allowfullscreen
                  loading="lazy"
                  title="Product demonstration video for {{ product.title }}"
                ></iframe>
              {% else %}
                <video controls loading="lazy">
                  <source src="{{ video_url }}" type="video/mp4">
                  Your browser does not support the video tag.
                </video>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endif %}
    
    {% if has_brochure %}
      <div 
        class="product-tabs__panel" 
        role="tabpanel"
        aria-labelledby="nav-brochure-{{ product.id }}"
        id="tab-brochure-{{ product.id }}"
        data-tab-content="brochure"
      >
        <div class="product-tabs__panel-content">
          <h3 class="product-tabs__panel-title">Downloads</h3>
          <div class="product-tabs__download-content">
            <div class="download-links">
              {% assign brochure_url = product.metafields.features.brochure_url %}
              <a href="{{ brochure_url }}" class="download-link" target="_blank" rel="noopener">
                {% render 'icon-download' %}
                <span>Download Product Brochure</span>
                <small>PDF Document</small>
              </a>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const productTabs = document.querySelector('[data-vitals-product-tabs]');
    if (!productTabs) return;
    
    const tabButtons = productTabs.querySelectorAll('.product-tabs__nav-button');
    const tabPanels = productTabs.querySelectorAll('.product-tabs__panel');
    
    tabButtons.forEach(button => {
      button.addEventListener('click', function() {
        const targetTab = this.getAttribute('data-tab');
        
        // Remove active states
        tabButtons.forEach(btn => {
          btn.classList.remove('active');
          btn.setAttribute('aria-selected', 'false');
        });
        
        tabPanels.forEach(panel => {
          panel.classList.remove('active');
        });
        
        // Add active states
        this.classList.add('active');
        this.setAttribute('aria-selected', 'true');
        
        const targetPanel = productTabs.querySelector(`[data-tab-content="${targetTab}"]`);
        if (targetPanel) {
          targetPanel.classList.add('active');
        }
        
        // Fire event for Vitals integration
        window.dispatchEvent(new CustomEvent('vitals:productTabChanged', {
          detail: {
            productId: {{ product.id }},
            activeTab: targetTab,
            productHandle: '{{ product.handle }}'
          }
        }));
      });
    });
  });
</script>
{% endif %}