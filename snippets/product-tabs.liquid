<!-- Product Tabs Block -->
<div class="product-tabs" {{ block.shopify_attributes }}>
  {{ 'product-tabs.css' | asset_url | stylesheet_tag }}
  
  <!-- Tab Navigation -->
  <div class="product-tabs__nav">
    <button class="product-tabs__button active" data-tab="description">
      {{ block.settings.description_tab_label | default: 'Description' }}
    </button>
    
    {%- comment -%} Check if product has features metafields {%- endcomment -%}
    {%- assign has_features = false -%}
    {%- for metafield in product.metafields.custom -%}
      {%- if metafield[0] contains 'feature' and metafield[1] != blank -%}
        {%- assign has_features = true -%}
        {%- break -%}
      {%- endif -%}
    {%- endfor -%}
    
    {%- if has_features -%}
      <button class="product-tabs__button" data-tab="features">
        {{ block.settings.features_tab_label | default: 'Features' }}
      </button>
    {%- endif -%}
    
    {%- comment -%} Check if product has specifications metafields {%- endcomment -%}
    {%- assign has_specs = false -%}
    {%- for metafield in product.metafields.custom -%}
      {%- unless metafield[0] contains 'feature' -%}
        {%- if metafield[1] != blank -%}
          {%- assign has_specs = true -%}
          {%- break -%}
        {%- endif -%}
      {%- endunless -%}
    {%- endfor -%}
    
    {%- if has_specs -%}
      <button class="product-tabs__button" data-tab="specifications">
        {{ block.settings.specs_tab_label | default: 'Specifications' }}
      </button>
    {%- endif -%}
    
    <button class="product-tabs__button" data-tab="reviews">
      {{ block.settings.reviews_tab_label | default: 'Reviews' }}
    </button>
  </div>
  
  <!-- Tab Content -->
  <div class="product-tabs__content">
    <!-- Description Tab -->
    <div class="product-tabs__panel active" data-panel="description">
      {%- if product.description != blank -%}
        <div class="rte">
          {{ product.description }}
        </div>
      {%- else -%}
        <p>No description available for this product.</p>
      {%- endif -%}
    </div>
    
    <!-- Features Tab -->
    {%- if has_features -%}
      <div class="product-tabs__panel" data-panel="features">
        <div class="product-features">
          {%- comment -%} Look for pipe-separated features list {%- endcomment -%}
          {%- if product.metafields.custom.features != blank and product.metafields.custom.features contains '|' -%}
            {%- assign features_list = product.metafields.custom.features | split: '|' -%}
            {%- for feature in features_list -%}
              <div class="feature-item">
                <h4>{{ feature | strip }}</h4>
              </div>
            {%- endfor -%}
          {%- else -%}
            {%- comment -%} Show individual feature metafields {%- endcomment -%}
            {%- for metafield in product.metafields.custom -%}
              {%- if metafield[0] contains 'feature' and metafield[1] != blank -%}
                <div class="feature-item">
                  <h4>{{ metafield[0] | replace: '_', ' ' | capitalize }}</h4>
                  <p>{{ metafield[1] }}</p>
                </div>
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
        </div>
      </div>
    {%- endif -%}
    
    <!-- Specifications Tab -->
    {%- if has_specs -%}
      <div class="product-tabs__panel" data-panel="specifications">
        <div class="specifications-grid">
          {%- for metafield in product.metafields.custom -%}
            {%- unless metafield[0] contains 'feature' -%}
              {%- if metafield[1] != blank -%}
                <div class="spec-item">
                  <dt>{{ metafield[0] | replace: '_', ' ' | capitalize }}</dt>
                  <dd>{{ metafield[1] }}</dd>
                </div>
              {%- endif -%}
            {%- endunless -%}
          {%- endfor -%}
        </div>
      </div>
    {%- endif -%}
    
    <!-- Reviews Tab -->
    <div class="product-tabs__panel" data-panel="reviews">
      <div class="product-reviews">
        <div class="reviews-header">
          <h3>Customer Reviews</h3>
          <button class="write-review-btn" onclick="openVitalsReviewForm()">
            Write a Review
          </button>
        </div>
        
        {%- comment -%} Vitals Reviews Integration {%- endcomment -%}
        <div id="vitals-reviews-container" data-product-id="{{ product.id }}">
          <!-- Vitals reviews will be loaded here -->
        </div>
        
        <div class="reviews-placeholder">
          <p>Customer reviews will appear here.</p>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Simple tab functionality
    document.addEventListener('DOMContentLoaded', function() {
      const tabButtons = document.querySelectorAll('.product-tabs__button');
      const tabPanels = document.querySelectorAll('.product-tabs__panel');
      
      tabButtons.forEach(button => {
        button.addEventListener('click', function() {
          const tabName = this.getAttribute('data-tab');
          
          // Remove active class from all buttons and panels
          tabButtons.forEach(btn => btn.classList.remove('active'));
          tabPanels.forEach(panel => panel.classList.remove('active'));
          
          // Add active class to clicked button and corresponding panel
          this.classList.add('active');
          const targetPanel = document.querySelector(`[data-panel="${tabName}"]`);
          if (targetPanel) {
            targetPanel.classList.add('active');
          }
        });
      });
    });
    
    // Vitals review form integration
    function openVitalsReviewForm() {
      // Try multiple approaches to trigger Vitals review form
      if (typeof VITALS !== 'undefined' && VITALS.reviews) {
        VITALS.reviews.openForm({{ product.id }});
      } else if (window.vitalsApp && window.vitalsApp.reviews) {
        window.vitalsApp.reviews.openForm({{ product.id }});
      } else {
        // Fallback: trigger existing Vitals elements
        const vitalsButton = document.querySelector('[data-vitals-action="reviews-form"], .vitals-review-button');
        if (vitalsButton) {
          vitalsButton.click();
        } else {
          alert('Please scroll down to see the reviews section to write a review.');
        }
      }
    }
  </script>
</div>